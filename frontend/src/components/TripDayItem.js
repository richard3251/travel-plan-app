import React, { useState, useEffect, useCallback } from 'react';
import { tripPlaceApi, placeApi } from '../api/api';
import TripPlaceItem from './TripPlaceItem';
import './TripDayItem.css';
import { DragDropContext, Droppable, Draggable } from '@hello-pangea/dnd';

const TripDayItem = ({ tripDay, tripId, onDeleteDay }) => {
  const [tripPlaces, setTripPlaces] = useState([]);
  const [loading, setLoading] = useState(true);
  const [editingPlace, setEditingPlace] = useState(null);
  const [editData, setEditData] = useState({
    memo: '',
    visitTime: ''
  });
  
  const fetchPlaces = useCallback(async () => {
    try {
      const response = await tripPlaceApi.getTripPlaces(tripDay.id);
      setTripPlaces(response.data);
      setLoading(false);
    } catch (err) {
      setLoading(false);
      alert('Ïû•ÏÜå Î™©Î°ùÏùÑ Í∞ÄÏ†∏Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    }
  }, [tripDay.id]);
  
  useEffect(() => {
    fetchPlaces();
  }, [tripDay.id, fetchPlaces]);
  
  const handleUpdatePlace = async (placeId, updatedData) => {
    try {
      const response = await tripPlaceApi.updateTripPlace(tripDay.id, placeId, updatedData);
      setTripPlaces(tripPlaces.map(place => 
        place.id === placeId ? response.data : place
      ));
    } catch (err) {
      alert('Ïû•ÏÜåÎ•º ÏàòÏ†ïÌïòÎäîÎç∞ Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    }
  };

  const handleDragEnd = async (result) => {
    if (!result.destination) return;
    if (result.destination.index === result.source.index) return;
    
    try {
      const sortedPlaces = [...tripPlaces].sort((a, b) => a.visitOrder - b.visitOrder);
      const draggedPlace = sortedPlaces[result.source.index];
      const newVisitOrder = result.destination.index + 1;
      
      await tripPlaceApi.updateTripPlaceOrder(
        tripDay.id, 
        draggedPlace.id, 
        { visitOrder: newVisitOrder }
      );
      
      await fetchPlaces();
    } catch (err) {
      alert('Ïû•ÏÜå ÏàúÏÑúÎ•º Î≥ÄÍ≤ΩÌïòÎäîÎç∞ Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
      fetchPlaces();
    }
  };
  
  const handleDeletePlace = async (placeId) => {
    if (window.confirm('Ï†ïÎßêÎ°ú Ïù¥ Ïû•ÏÜåÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
      try {
        await tripPlaceApi.deleteTripPlace(tripDay.id, placeId);
        setTripPlaces(tripPlaces.filter(place => place.id !== placeId));
        alert('Ïû•ÏÜåÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
      } catch (err) {
        alert('Ïû•ÏÜåÎ•º ÏÇ≠Ï†úÌïòÎäîÎç∞ Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
      }
    }
  };

  const handleEditPlace = (place) => {
    setEditingPlace(place.id);
    setEditData({
      memo: place.memo || '',
      visitTime: place.visitTime || ''
    });
  };

  const handleSavePlace = async (placeId) => {
    try {
      const place = tripPlaces.find(p => p.id === placeId);
      const updatedPlace = { 
        ...place, 
        memo: editData.memo,
        visitTime: editData.visitTime
      };
      await tripPlaceApi.updateTripPlace(tripDay.id, placeId, updatedPlace);
      setTripPlaces(tripPlaces.map(p => 
        p.id === placeId ? { ...p, memo: editData.memo, visitTime: editData.visitTime } : p
      ));
      setEditingPlace(null);
      setEditData({ memo: '', visitTime: '' });
      alert('Ïû•ÏÜå Ï†ïÎ≥¥Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
    } catch (err) {
      alert('Ïû•ÏÜå Ï†ïÎ≥¥Î•º Ï†ÄÏû•ÌïòÎäîÎç∞ Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    }
  };

  const handleCancelEdit = () => {
    setEditingPlace(null);
    setEditData({ memo: '', visitTime: '' });
  };

  const handleInputChange = (field, value) => {
    setEditData(prev => ({
      ...prev,
      [field]: value
    }));
  };
  
  const handleDeleteDay = () => {
    if (window.confirm('Ï†ïÎßêÎ°ú Ïù¥ ÎÇ†ÏßúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Î™®Îì† Ïû•ÏÜå Ï†ïÎ≥¥Í∞Ä Ìï®Íªò ÏÇ≠Ï†úÎê©ÎãàÎã§.')) {
      onDeleteDay(tripDay.id);
    }
  };
  
  return (
    <div className="day-card">
      <div className="day-header">
        <h4>DAY {tripDay.day} - {new Date(tripDay.date).toLocaleDateString()}</h4>
        <div className="day-actions">
          <button 
            className="delete-day-button"
            onClick={handleDeleteDay}
          >
            ÎÇ†Ïßú ÏÇ≠Ï†ú
          </button>
        </div>
      </div>
      
      <div className="day-places">
        {loading ? (
          <p className="loading-places">Ïû•ÏÜåÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
        ) : tripPlaces.length > 0 ? (
          <div>
            <p className="drag-instruction">
              ÎìúÎûòÍ∑∏Ìï¥ÏÑú ÏàúÏÑúÎ•º Î≥ÄÍ≤ΩÌïòÏÑ∏Ïöî
            </p>
            
            <DragDropContext onDragEnd={handleDragEnd}>
              <Droppable droppableId="places">
                {(provided) => (
                  <div 
                    ref={provided.innerRef}
                    {...provided.droppableProps}
                    className="places-container"
                  >
                    {tripPlaces
                      .sort((a, b) => a.visitOrder - b.visitOrder)
                      .map((place, index) => (
                        <Draggable 
                          key={place.id} 
                          draggableId={place.id.toString()} 
                          index={index}
                        >
                          {(provided, snapshot) => (
                            <div
                              ref={provided.innerRef}
                              {...provided.draggableProps}
                              {...provided.dragHandleProps}
                              className={`place-card ${snapshot.isDragging ? 'dragging' : ''}`}
                            >
                              <div className="place-header">
                                <div className="place-number">#{index + 1}</div>
                                <div className="place-time">{place.visitTime}</div>
                                <div className="place-actions">
                                  <button 
                                    className="edit-place-button"
                                    onClick={() => handleEditPlace(place)}
                                    title="Ïû•ÏÜå Ï†ïÎ≥¥ ÏàòÏ†ï"
                                  >
                                    Ïû•ÏÜå ÏàòÏ†ï
                                  </button>
                                  <button 
                                    className="delete-place-button"
                                    onClick={() => handleDeletePlace(place.id)}
                                    title="Ïû•ÏÜå ÏÇ≠Ï†ú"
                                  >
                                    Ïû•ÏÜå ÏÇ≠Ï†ú
                                  </button>
                                </div>
                              </div>
                              
                              <div className="place-info">
                                <div className="place-name">{place.placeName}</div>
                                <div className="place-address">{place.address}</div>
                                
                                {editingPlace === place.id ? (
                                  <div className="place-edit-form">
                                    <div className="edit-field">
                                      <label htmlFor={`visitTime-${place.id}`}>Î∞©Î¨∏ ÏãúÍ∞Ñ</label>
                                      <input
                                        type="time"
                                        id={`visitTime-${place.id}`}
                                        value={editData.visitTime}
                                        onChange={(e) => handleInputChange('visitTime', e.target.value)}
                                        className="time-input"
                                      />
                                    </div>
                                    <div className="edit-field">
                                      <label htmlFor={`memo-${place.id}`}>Î©îÎ™®</label>
                                      <textarea
                                        id={`memo-${place.id}`}
                                        value={editData.memo}
                                        onChange={(e) => handleInputChange('memo', e.target.value)}
                                        placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                                        className="memo-textarea"
                                        rows="3"
                                      />
                                    </div>
                                    <div className="edit-actions">
                                      <button 
                                        className="save-button"
                                        onClick={() => handleSavePlace(place.id)}
                                      >
                                        Ï†ÄÏû•
                                      </button>
                                      <button 
                                        className="cancel-button"
                                        onClick={handleCancelEdit}
                                      >
                                        Ï∑®ÏÜå
                                      </button>
                                    </div>
                                  </div>
                                ) : (
                                  place.memo && (
                                    <div className="place-memo">
                                      üí≠ {place.memo}
                                    </div>
                                  )
                                )}
                              </div>
                            </div>
                          )}
                        </Draggable>
                      ))}
                    {provided.placeholder}
                  </div>
                )}
              </Droppable>
            </DragDropContext>
          </div>
        ) : (
          <p className="no-places">Îì±Î°ùÎêú Ïû•ÏÜåÍ∞Ä ÏóÜÏäµÎãàÎã§. Ïû•ÏÜå Ï∂îÍ∞Ä Î≤ÑÌäºÏùÑ ÏÇ¨Ïö©Ìï¥ Ïû•ÏÜåÎ•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî!</p>
        )}
      </div>
    </div>
  );
};

export default TripDayItem; 
